{% extends 'global/base.html' %}
{% load static %}

{% block content %}
<div class="content nova-venda">
  <div class="page-header">
    <h1>Nova Venda</h1>
  </div>

  {% if messages %}
  <div class="mb-4">
    {% for message in messages %}
    <div class="message {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <form id="form-venda" method="post" action=".">
    {% csrf_token %}

    <!-- ===================== TUTOR & ANIMAL ===================== -->
    <section class="card">
      <h2>Cliente e Animal</h2>

      <div class="grid grid-2">
        <!-- Tutor -->
        <div class="form-group">
          <label for="tutor-input">Tutor</label>
          <input type="text" id="tutor-input" placeholder="Digite para buscar o tutor..." autocomplete="off"
            class="form-control">
          <input type="hidden" id="tutor-id" name="tutor_id">
          <small id="tutor-selecionado" class="muted"></small>
        </div>

        <!-- Animal (select carregado após escolher o tutor) -->
        <div class="form-group">
          <label for="animal-select">Animal</label>
          <select id="animal-select" name="animal_id" class="form-control" disabled>
            <option value="">Selecione primeiro o tutor...</option>
          </select>
          <small id="animal-selecionado" class="muted"></small>
        </div>
      </div>

      <div class="actions mt-2">
        <button type="button" id="btn-iniciar-atendimento" class="btn btn-primary" disabled>
          Iniciar Atendimento
        </button>
        <!-- URL base com placeholder 0 para evitar NoReverseMatch -->
        <input type="hidden" id="atendimento-url-base" value="{% url 'clinica:atendimento_novo' 0 %}">
      </div>
    </section>

    <!-- ===================== PRODUTOS / SERVIÇOS ===================== -->
    <section class="card">
      <h2>Produtos & Serviços</h2>

      <div class="grid grid-3">
        <div class="form-group">
          <label for="busca-item">Buscar item</label>
          <input type="text" id="busca-item" placeholder="Nome do produto/serviço" autocomplete="off"
            class="form-control">
        </div>
        <div class="form-group">
          <label for="quantidade-item">Quantidade</label>
          <input type="number" id="quantidade-item" min="1" step="1" value="1" class="form-control">
        </div>
        <div class="align-end">
          <button type="button" id="adicionar-item" class="btn btn-secondary">Adicionar</button>
        </div>
      </div>

      <div class="responsive-table mt-2">
        <table id="tabela-itens" class="table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Tipo</th>
              <th>Qtd</th>
              <th>Preço (R$)</th>
              <th>Subtotal (R$)</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="right"><strong>Total (R$)</strong></td>
              <td colspan="2"><input type="text" id="total-geral" value="0,00" readonly class="form-control"></td>
            </tr>
            <tr>
              <td colspan="4" class="right">Desconto (R$)</td>
              <td colspan="2"><input type="text" id="desconto" value="0,00" inputmode="decimal" class="form-control">
              </td>
            </tr>
            <tr>
              <td colspan="4" class="right"><strong>Final (R$)</strong></td>
              <td colspan="2"><input type="text" id="total-final" value="0,00" readonly class="form-control"></td>
            </tr>
            <tr>
              <td colspan="4" class="right">Valor Recebido (R$)</td>
              <td colspan="2"><input type="text" id="valor-recebido" value="0,00" inputmode="decimal"
                  class="form-control"></td>
            </tr>
            <tr>
              <td colspan="4" class="right">Troco (R$)</td>
              <td colspan="2"><input type="text" id="troco" value="0,00" readonly class="form-control"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <section class="actions mt-3">
      <button type="submit" class="btn btn-success">Finalizar Venda</button>
      <a href="{% url 'clinica:home_view' %}" class="btn btn-light">Cancelar</a>
    </section>
  </form>
</div>
{% endblock content %}

{% block extra_js %}
<!-- jQuery + jQuery UI (para o autocomplete de tutor e de itens) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<script>
  (function () {
    const URLS = {
      clientes: "{% url 'clinica:buscar_clientes' %}",
      animais: "{% url 'clinica:buscar_animais' %}",     // GET ?tutor_id=ID[&q=...]
      itens: "{% url 'clinica:buscar_produtos_servicos' %}" // GET ?q=...
    };

    // Helpers de dinheiro
    function parseMoney(v) { return parseFloat(String(v).replace(/\./g, '').replace(',', '.')) || 0; }
    function fmtMoney(n) { return (Number(n) || 0).toFixed(2).replace('.', ','); }

    // Estado da tabela
    const itens = []; // {id, nome, tipo, qtd, preco}

    // Render da tabela
    function renderTabela() {
      const $tbody = $('#tabela-itens tbody');
      $tbody.empty();
      let total = 0;

      itens.forEach((it, idx) => {
        const subtotal = it.qtd * it.preco;
        total += subtotal;
        $tbody.append(`
        <tr>
          <td>${it.nome}</td>
          <td>${it.tipo || '-'}</td>
          <td><input type="number" class="form-control qtd-item" min="1" step="1" value="${it.qtd}" data-idx="${idx}"></td>
          <td>${fmtMoney(it.preco)}</td>
          <td>${fmtMoney(subtotal)}</td>
          <td><button type="button" class="btn btn-small btn-danger" data-remove="${idx}">Remover</button></td>
        </tr>
      `);
      });

      $('#total-geral').val(fmtMoney(total));
      const desc = parseMoney($('#desconto').val());
      const final = Math.max(total - desc, 0);
      $('#total-final').val(fmtMoney(final));

      const recebido = parseMoney($('#valor-recebido').val());
      $('#troco').val(fmtMoney(Math.max(recebido - final, 0)));
    }

    // Eventos da tabela
    $(document).on('input', '.qtd-item', function () {
      const idx = Number($(this).data('idx'));
      itens[idx].qtd = Math.max(parseInt($(this).val() || '1', 10), 1);
      renderTabela();
    });
    $(document).on('click', '[data-remove]', function () {
      itens.splice(Number($(this).data('remove')), 1);
      renderTabela();
    });
    $('#desconto, #valor-recebido').on('input', renderTabela);

    // -------- Autocomplete de Tutor --------
    $('#tutor-input').autocomplete({
      minLength: 1,
      autoFocus: true,
      appendTo: 'body',
      source: function (req, res) {
        $.getJSON(URLS.clientes, { q: req.term })
          .done(function (data) {
            res((data || []).map(x => ({
              label: x.nome + (x.documento ? ' (' + x.documento + ')' : ''),
              value: x.nome,
              id: x.id,
              raw: x
            })));
          })
          .fail(() => res([]));
      },
      select: function (e, ui) {
        if (!ui.item || !ui.item.id) return false;
        $('#tutor-id').val(ui.item.id);
        $('#tutor-selecionado').text('Tutor selecionado: ' + (ui.item.raw?.nome || ui.item.value));
        // limpa animal e carrega os animais do tutor
        $('#animal-select').prop('disabled', true).html('<option value="">Carregando animais...</option>');
        carregarAnimaisDoTutor(ui.item.id);
        // desabilita botão até escolher animal
        $('#btn-iniciar-atendimento').prop('disabled', true);
        return false;
      }
    });

    // -------- Carregar todos os animais do tutor --------
    function carregarAnimaisDoTutor(tutorId) {
      $.getJSON(URLS.animais, { tutor_id: tutorId })
        .done(function (data) {
          const $sel = $('#animal-select');
          if (!Array.isArray(data) || !data.length) {
            $sel.html('<option value="">Nenhum animal encontrado para este tutor</option>').prop('disabled', true);
            $('#animal-selecionado').text('');
            return;
          }
          $sel.html('<option value="">-- Selecione --</option>');
          data.forEach(a => {
            const label = a.nome + (a.especie ? ' (' + a.especie + ')' : '');
            $sel.append(`<option value="${a.id}">${label}</option>`);
          });
          $sel.prop('disabled', false);
        })
        .fail(function (jq) {
          console.error('[animais] ERRO', jq.status, jq.responseText);
          $('#animal-select').html('<option value="">Erro ao carregar animais</option>').prop('disabled', true);
        });
    }

    // Seleção do animal
    $('#animal-select').on('change', function () {
      const val = $(this).val();
      const txt = $(this).find('option:selected').text();
      if (!val) {
        $('#animal-selecionado').text('');
        $('#btn-iniciar-atendimento').prop('disabled', true);
        return;
      }
      $('#animal-selecionado').text('Animal selecionado: ' + txt);
      $('#btn-iniciar-atendimento').prop('disabled', false);
    });

    // Iniciar atendimento
    $('#btn-iniciar-atendimento').on('click', function () {
      const id = $('#animal-select').val();
      if (!id) return;
      const base = $('#atendimento-url-base').val(); // ex.: /atendimento/novo/0/
      const url = base.replace(/0\/?$/, String(id) + '/');
      window.location.href = url;
    });

    // -------- Autocomplete de Itens --------
    $('#busca-item').autocomplete({
      minLength: 2,
      appendTo: 'body',
      source: function (req, res) {
        $.getJSON(URLS.itens, { q: req.term })
          .done(function (data) {
            res((data || []).map(x => ({
              label: x.nome + ' — R$ ' + fmtMoney(x.preco),
              value: x.nome,
              id: x.id,
              raw: x
            })));
          })
          .fail(() => res([]));
      },
      select: function (e, ui) {
        if (!ui.item || !ui.item.id) return false;
        const qtd = Math.max(parseInt($('#quantidade-item').val() || '1', 10), 1);
        const idx = itens.findIndex(i => String(i.id) === String(ui.item.id));
        if (idx >= 0) { itens[idx].qtd += qtd; }
        else {
          itens.push({
            id: ui.item.id,
            nome: ui.item.raw.nome,
            tipo: ui.item.raw.tipo || '',
            qtd: qtd,
            preco: Number(ui.item.raw.preco) || 0
          });
        }
        $('#busca-item').val('');
        $('#quantidade-item').val(1);
        renderTabela();
        return false;
      }
    });

    // Adicionar item manualmente (fallback)
    $('#adicionar-item').on('click', function () {
      const nome = ($('#busca-item').val() || '').trim();
      if (!nome) return;
      const qtd = Math.max(parseInt($('#quantidade-item').val() || '1', 10), 1);
      itens.push({ id: 'temp-' + Date.now(), nome, tipo: '', qtd, preco: 0 });
      $('#busca-item').val('');
      $('#quantidade-item').val(1);
      renderTabela();
    });

    // Render inicial
    renderTabela();
  })();
</script>
{% endblock extra_js %}